<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		
		<link href="../../../../_app/immutable/assets/0.dbac244e.css" rel="stylesheet">
		<link href="../../../../_app/immutable/assets/2.7003dda6.css" rel="stylesheet">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/start.14e2260b.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/scheduler.63274e7e.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/singletons.7cfa083e.js">
		<link rel="modulepreload" href="../../../../_app/immutable/entry/app.a9b1b2ed.js">
		<link rel="modulepreload" href="../../../../_app/immutable/chunks/index.d9809aad.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/0.e1105dad.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/2.ebdbf35e.js">
		<link rel="modulepreload" href="../../../../_app/immutable/nodes/21.aeabc0e5.js">
	</head>
	<body>
		<div>   <div class="svelte-1yjh0wm"><header data-svelte-h="svelte-lgw146"><h1 class="svelte-1yjh0wm">Mark Temple-Heald</h1> <h2 class="svelte-1yjh0wm">the right tool for the job</h2></header>  <nav class="svelte-z3ooaf" data-svelte-h="svelte-4jee8c"><ul class="svelte-z3ooaf"><li class="svelte-z3ooaf"><a href="/" class="navAnchor">Home</a></li> <li class="svelte-z3ooaf"><a href="/blog" class="navAnchor">Blog</a></li> <li class="svelte-z3ooaf"><a href="/topic" class="navAnchor">Topic</a></li> <li class="svelte-z3ooaf"><a href="/about" class="navAnchor">About</a></li></ul> </nav> </div> <main class="svelte-1l5lemn"><h1 data-svelte-h="svelte-bb1m4l">Sharing environments between projects in Azure DevOps</h1> <p data-svelte-h="svelte-mmpop6">This is useful for multiple websites held in different projects hosted in the same IIS instance on the same server(s). Alternatively, for microservices hosted on a Virtual Machine, if deployed independently.</p> <h2 data-svelte-h="svelte-1qwlvvu">The issue</h2> <p data-svelte-h="svelte-6vjq4x">Azure DevOps generates the script for you to install a build/release agent on a server, within the Environments tab of the Pipelines section of the Project.</p> <p data-svelte-h="svelte-1gauxpm">This works fine, the first time.
You can view the results of this in the DevOps portal <code>https://dev.azure.com/&lt;Team&gt;/_settings/deploymentPools</code>.
The default names for Deployment Groups (used by releases) is <code>&lt;Project&gt;-&lt;Environment&gt;</code>.
The default names for Environments (used by pipelines) is <code>environment-&lt;environment-id&gt;-&lt;guid&gt;</code>.
These names can be changed to aid ongoing maintenance.</p> <p data-svelte-h="svelte-zbwpnm">If you try to create a second agent on the same VM, in the same way, it will do one of 2 things:</p> <ul data-svelte-h="svelte-1ohkpg5"><li>Overwrite the first, meaning that any pipelines which reference this will cease to function</li> <li>Fail to create since it can’t delete the first agent.
In this case the second agent always shows as offline and the new pipeline won’t run.
<code>Unable to deploy to the virtual machine &#39;XXX&#39; as the machine is offline</code></li></ul> <p data-svelte-h="svelte-outdpg">Others have reported <a href="https://github.com/MicrosoftDocs/azure-devops-docs/issues/8578" rel="nofollow">this issue</a> and provided an alternative script. I am not comfortable just running scripts from the web, I prefer a future proof understanding of the problem.</p> <h2 data-svelte-h="svelte-fem3ok">The solution</h2> <p data-svelte-h="svelte-1q6fsiv">The reason for this issue is that the script generates an agent with a name matching the VM by default.
The DevOps-generated script is one-lined but otherwise not hard to dissect.
In the line which calls <code>config</code> we need to change the <code>agent</code> parameter to something unique, either by appending the agent folder (<code>$destFolder</code> in the script), e.g. HOSTNAME-A3, or with something which indicates the purpose of this agent, e.g. HOSTNAME-ServiceX or HOSTNAME-WebsiteX, in which case we should probably update the script to create a folder name to match this.</p> <h2 data-svelte-h="svelte-82q5qk">The future</h2> <p data-svelte-h="svelte-1dchy4b">A <a href="https://developercommunity.visualstudio.com/t/can-environments-be-shared-across-team-projects/676255" rel="nofollow">proposal</a> has been made to Microsoft to allow environment sharing but doesn’t seem active.</p> <p data-svelte-h="svelte-12js8r5">Interestingly this was <a href="https://devblogs.microsoft.com/devops/sharing-of-deployment-groups-across-projects/" rel="nofollow">resolved</a> in the past for deployment groups, which are used by releases (as opposed to pipelines), so I’d assume that this will come eventually.</p></main>  <footer class="svelte-1g9mmpv" data-svelte-h="svelte-zr9zc5"><p>This is my site, there are many like it but this one is mine.</p> <p>If you don&#39;t like it, you know where the close button is.</p> <a href="https://www.linkedin.com/in/mtempleheald" target="_blank" class="svelte-1g9mmpv">Mark Temple-Heald</a> <a href="https://mtempleheald.github.io" target="_blank" class="svelte-1g9mmpv">Home</a> <a href="https://github.com/mtempleheald" target="_blank" class="svelte-1g9mmpv">GitHub</a> <p>Mindful meanderings manifest more manageable machinations. Manoeuvring murky multifaceted
		modernism means meticulously managing many mistakes, misconceptions, misunderstandings. Measured
		multipronged musings, mechanical movements, may maximise meritorious magnificence.</p> </footer> 
			
			<script>
				{
					__sveltekit_fm2sxp = {
						base: new URL("../../../..", location).pathname.slice(0, -1),
						env: {}
					};

					const element = document.currentScript.parentElement;

					const data = [null,null,null];

					Promise.all([
						import("../../../../_app/immutable/entry/start.14e2260b.js"),
						import("../../../../_app/immutable/entry/app.a9b1b2ed.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 2, 21],
							data,
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
