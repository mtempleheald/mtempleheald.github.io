<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<meta http-equiv="content-security-policy" content="">
	<link href="../../../../_app/immutable/assets/+layout-ca4151f4.css" rel="stylesheet">
	<link rel="modulepreload" href="../../../../_app/immutable/start-543600b3.js">
	<link rel="modulepreload" href="../../../../_app/immutable/chunks/index-c16a1df2.js">
	<link rel="modulepreload" href="../../../../_app/immutable/chunks/singletons-60e13bd4.js">
	<link rel="modulepreload" href="../../../../_app/immutable/components/pages/_layout.svelte-e6d0b583.js">
	<link rel="modulepreload" href="../../../../_app/immutable/components/pages/blog/2021/03/16/DevOps-Shared-Environments/_page.md-d8ac8880.js">
	</head>
	<body>
		<div>



<div class="svelte-1yjh0wm"><header><h1 class="svelte-1yjh0wm">Mark Temple-Heald</h1>
		<h2 class="svelte-1yjh0wm">the right tool for the job</h2></header>
	
<nav class="svelte-z3ooaf"><ul class="svelte-z3ooaf"><li class="svelte-z3ooaf"><a href="/" class="navAnchor">Home</a></li>
		<li class="svelte-z3ooaf"><a href="/blog" class="navAnchor">Blog</a></li>
		<li class="svelte-z3ooaf"><a href="/topic" class="navAnchor">Topic</a></li>
		<li class="svelte-z3ooaf"><a href="/about" class="navAnchor">About</a></li></ul>
</nav>
</div>

<main class="svelte-lv7236"><h1>Sharing environments between projects in Azure DevOps</h1>
<p>This is useful for multiple websites held in different projects hosted in the same IIS instance on the same server(s). Alternatively, for microservices hosted on a Virtual Machine, if deployed independently.</p>
<h2>The issue</h2>
<p>Azure DevOps generates the script for you to install a build/release agent on a server, within the Environments tab of the Pipelines section of the Project.</p>
<p>This works fine, the first time.
You can view the results of this in the DevOps portal <code>https://dev.azure.com/&lt;Team&gt;/_settings/deploymentPools</code>.
The default names for Deployment Groups (used by releases) is <code>&lt;Project&gt;-&lt;Environment&gt;</code>.
The default names for Environments (used by pipelines) is <code>environment-&lt;environment-id&gt;-&lt;guid&gt;</code>.
These names can be changed to aid ongoing maintenance.</p>
<p>If you try to create a second agent on the same VM, in the same way, it will do one of 2 things:</p>
<ul><li>Overwrite the first, meaning that any pipelines which reference this will cease to function</li>
<li>Fail to create since it can’t delete the first agent.
In this case the second agent always shows as offline and the new pipeline won’t run.
<code>Unable to deploy to the virtual machine &#39;XXX&#39; as the machine is offline</code></li></ul>
<p>Others have reported <a href="https://github.com/MicrosoftDocs/azure-devops-docs/issues/8578" rel="nofollow">this issue</a> and provided an alternative script. I am not comfortable just running scripts from the web, I prefer a future proof understanding of the problem.</p>
<h2>The solution</h2>
<p>The reason for this issue is that the script generates an agent with a name matching the VM by default.
The DevOps-generated script is one-lined but otherwise not hard to dissect.
In the line which calls <code>config</code> we need to change the <code>agent</code> parameter to something unique, either by appending the agent folder (<code>$destFolder</code> in the script), e.g. HOSTNAME-A3, or with something which indicates the purpose of this agent, e.g. HOSTNAME-ServiceX or HOSTNAME-WebsiteX, in which case we should probably update the script to create a folder name to match this.</p>
<h2>The future</h2>
<p>A <a href="https://developercommunity.visualstudio.com/t/can-environments-be-shared-across-team-projects/676255" rel="nofollow">proposal</a> has been made to Microsoft to allow environment sharing but doesn’t seem active.</p>
<p>Interestingly this was <a href="https://devblogs.microsoft.com/devops/sharing-of-deployment-groups-across-projects/" rel="nofollow">resolved</a> in the past for deployment groups, which are used by releases (as opposed to pipelines), so I’d assume that this will come eventually.</p></main>


<footer class="svelte-1g9mmpv"><p>This is my site, there are many like it but this one is mine.</p>
	<p>If you don&#39;t like it, you know where the close button is.</p>
	<a href="https://www.linkedin.com/in/mtempleheald" target="_blank" class="svelte-1g9mmpv">Mark Temple-Heald</a>
	<a href="https://mtempleheald.github.io" target="_blank" class="svelte-1g9mmpv">Home</a>
	<a href="https://github.com/mtempleheald" target="_blank" class="svelte-1g9mmpv">GitHub</a>
	<p>Mindful meanderings manifest more manageable machinations. Manoeuvring murky multifaceted
		modernism means meticulously managing many mistakes, misconceptions, misunderstandings. Measured
		multipronged musings, mechanical movements, may maximise meritorious magnificence.
	</p>
</footer>


		<script type="module" data-sveltekit-hydrate="1747vm2">
		import { set_public_env, start } from "../../../../_app/immutable/start-543600b3.js";

		set_public_env({});

		start({
			target: document.querySelector('[data-sveltekit-hydrate="1747vm2"]').parentNode,
			paths: {"base":"","assets":""},
			route: true,
			spa: false,
			trailing_slash: "never",
			hydrate: {
				status: 200,
				error: null,
				node_ids: [0, 20],
				params: {},
				routeId: "blog/2021/03/16/DevOps-Shared-Environments"
			}
		});
	</script>
	</div>
	</body>
</html>
