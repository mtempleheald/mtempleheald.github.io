<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />

		<meta http-equiv="content-security-policy" content="">
	<link rel="stylesheet" href="/_app/assets/pages/__layout.svelte-711b4112.css">
	<link rel="modulepreload" href="/_app/start-e82316e2.js">
	<link rel="modulepreload" href="/_app/chunks/vendor-5ca848cc.js">
	<link rel="modulepreload" href="/_app/pages/__layout.svelte-8da8bfc2.js">
	<link rel="modulepreload" href="/_app/pages/blog/_slug_.svelte-db98abb9.js">
	</head>
	<body>
		<div>



<div class="svelte-1lrvsco"><header><h1 class="svelte-1lrvsco">Mark Temple-Heald</h1>
  <h2 class="svelte-1lrvsco">the right tool for the job</h2></header>

<nav class="svelte-r02kv1"><ul class="svelte-r02kv1"><li class="svelte-r02kv1"><a href="/" class="navAnchor">Home</a></li>
    <li class="svelte-r02kv1"><a href="/blog" class="navAnchor">Blog</a></li>
    <li class="svelte-r02kv1"><a href="/topic" class="navAnchor">Topic</a></li>
    <li class="svelte-r02kv1"><a href="/about" class="navAnchor">About</a></li></ul>
</nav>
</div>

<main class="svelte-lv7236"><!-- HTML_TAG_START --><h1>Sharing environments between projects in Azure DevOps</h1>This is useful for multiple websites held in different projects hosted in the same IIS instance on the same server(s).  Alternatively, for microservices hosted on a Virtual Machine, if deployed independently.<h2>The issue</h2>Azure DevOps generates the script for you to install a build/release agent on a server, within the Environments tab of the Pipelines section of the Project.<br />This works fine, the first time.
You can view the results of this in the DevOps portal <code>https://dev.azure.com/&lt;Team&gt;/_settings/deploymentPools</code>.
The default names for Deployment Groups (used by releases) is <code>&lt;Project&gt;-&lt;Environment&gt;</code>.
The default names for Environments (used by pipelines) is <code>environment-&lt;environment-id&gt;-&lt;guid&gt;</code>.
These names can be changed to aid ongoing maintenance.<br />If you try to create a second agent on the same VM, in the same way, it will do one of 2 things:<ul><li>Overwrite the first, meaning that any pipelines which reference this will cease to function</li><li>Fail to create since it can't delete the first agent.</li></ul>
  In this case the second agent always shows as offline and the new pipeline won't run. 
  <code>Unable to deploy to the virtual machine 'XXX' as the machine is offline</code><br />Others have reported <a href="https://github.com/MicrosoftDocs/azure-devops-docs/issues/8578">this issue</a> and provided an alternative script.  I am not comfortable just running scripts from the web, I prefer a future proof understanding of the problem.<h2>The solution</h2>The reason for this issue is that the script generates an agent with a name matching the VM by default.
The DevOps-generated script is one-lined but otherwise not hard to dissect.
In the line which calls <code>config</code> we need to change the <code>agent</code> parameter to something unique, either by appending the agent folder (<code>$destFolder</code> in the script), e.g. HOSTNAME-A3, or with something which indicates the purpose of this agent, e.g. HOSTNAME-ServiceX or HOSTNAME-WebsiteX, in which case we should probably update the script to create a folder name to match this.<h2>The future</h2>A <a href="https://developercommunity.visualstudio.com/t/can-environments-be-shared-across-team-projects/676255">proposal</a> has been made to Microsoft to allow environment sharing but doesn't seem active.<br />Interestingly this was <a href="https://devblogs.microsoft.com/devops/sharing-of-deployment-groups-across-projects/">resolved</a> in the past for deployment groups, which are used by releases (as opposed to pipelines), so I'd assume that this will come eventually.<!-- HTML_TAG_END --></main>


<footer class="svelte-14g1sgx"><p>This is my site, there are many like it but this one is mine.</p>
  <p>If you don&#39;t like it, you know where the close button is.</p>
  <a href="https://www.linkedin.com/in/mtempleheald" target="_blank" class="svelte-14g1sgx">Mark Temple-Heald</a>
  <a href="https://mtempleheald.github.io" target="_blank" class="svelte-14g1sgx">Home</a>
  <a href="https://github.com/mtempleheald" target="_blank" class="svelte-14g1sgx">GitHub</a>
  <p>Mindful meanderings manifest more manageable machinations.
    Manoeuvring murky multifaceted modernism means meticulously managing many mistakes, misconceptions, misunderstandings.
    Measured multipronged musings, mechanical movements, may maximise meritorious magnificence.
  </p>
</footer>


		<script type="module" data-hydrate="omdbdi">
		import { start } from "/_app/start-e82316e2.js";
		start({
			target: document.querySelector('[data-hydrate="omdbdi"]').parentNode,
			paths: {"base":"","assets":""},
			session: {},
			route: true,
			spa: false,
			trailing_slash: "never",
			hydrate: {
				status: 200,
				error: null,
				nodes: [
					import("/_app/pages/__layout.svelte-8da8bfc2.js"),
						import("/_app/pages/blog/_slug_.svelte-db98abb9.js")
				],
				url: new URL("http://sveltekit-prerender/blog/2021-03-16-DevOps-Shared-Environments"),
				params: {slug:"2021-03-16-DevOps-Shared-Environments"}
			}
		});
	</script><script type="application/json" data-type="svelte-data" data-url="/api/blogs/2021-03-16-DevOps-Shared-Environments">{"status":200,"statusText":"","headers":{"content-type":"text/plain;charset=UTF-8"},"body":"# Sharing environments between projects in Azure DevOps\n\nThis is useful for multiple websites held in different projects hosted in the same IIS instance on the same server(s).  Alternatively, for microservices hosted on a Virtual Machine, if deployed independently.\n\n## The issue\n\nAzure DevOps generates the script for you to install a build\u002Frelease agent on a server, within the Environments tab of the Pipelines section of the Project.\n\nThis works fine, the first time.\nYou can view the results of this in the DevOps portal `https:\u002F\u002Fdev.azure.com\u002F\u003CTeam\u003E\u002F_settings\u002FdeploymentPools`.\nThe default names for Deployment Groups (used by releases) is `\u003CProject\u003E-\u003CEnvironment\u003E`.\nThe default names for Environments (used by pipelines) is `environment-\u003Cenvironment-id\u003E-\u003Cguid\u003E`.\nThese names can be changed to aid ongoing maintenance.\n\nIf you try to create a second agent on the same VM, in the same way, it will do one of 2 things:\n- Overwrite the first, meaning that any pipelines which reference this will cease to function\n- Fail to create since it can't delete the first agent.\n  In this case the second agent always shows as offline and the new pipeline won't run. \n  `Unable to deploy to the virtual machine 'XXX' as the machine is offline`\n\nOthers have reported [this issue](https:\u002F\u002Fgithub.com\u002FMicrosoftDocs\u002Fazure-devops-docs\u002Fissues\u002F8578) and provided an alternative script.  I am not comfortable just running scripts from the web, I prefer a future proof understanding of the problem.\n\n## The solution\n\nThe reason for this issue is that the script generates an agent with a name matching the VM by default.\nThe DevOps-generated script is one-lined but otherwise not hard to dissect.\nIn the line which calls `config` we need to change the `agent` parameter to something unique, either by appending the agent folder (`$destFolder` in the script), e.g. HOSTNAME-A3, or with something which indicates the purpose of this agent, e.g. HOSTNAME-ServiceX or HOSTNAME-WebsiteX, in which case we should probably update the script to create a folder name to match this.\n\n## The future\n\nA [proposal](https:\u002F\u002Fdevelopercommunity.visualstudio.com\u002Ft\u002Fcan-environments-be-shared-across-team-projects\u002F676255) has been made to Microsoft to allow environment sharing but doesn't seem active.\n\nInterestingly this was [resolved](https:\u002F\u002Fdevblogs.microsoft.com\u002Fdevops\u002Fsharing-of-deployment-groups-across-projects\u002F) in the past for deployment groups, which are used by releases (as opposed to pipelines), so I'd assume that this will come eventually.\n\n"}</script></div>
	</body>
</html>
