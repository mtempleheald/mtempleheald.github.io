import{S as st,i as ot,s as it,k as r,q as o,a as f,l as a,m as l,r as i,h as t,c as p,n as j,b as h,I as s,C as Ve}from"../chunks/index.de0bb5b5.js";function nt(tt){let u,se,F,g,oe,k,I,ie,L,A,ne,U,c,re,H,ae,le,X,he,fe,C,pe,ce,G,D,de,W,m,z,ue,me,P,ve,N,we,Y,v,ye,_,be,Ee,$,M,_e,B,d,Te,V,Oe,ge,x,Ie,Ae,q,De,Pe,J,S,Me,K,w,Se,T,je,He,Q,y,Xe,O,Ce,ze;return{c(){u=r("h1"),se=o("Sharing environments between projects in Azure DevOps"),F=f(),g=r("p"),oe=o("This is useful for multiple websites held in different projects hosted in the same IIS instance on the same server(s). Alternatively, for microservices hosted on a Virtual Machine, if deployed independently."),k=f(),I=r("h2"),ie=o("The issue"),L=f(),A=r("p"),ne=o("Azure DevOps generates the script for you to install a build/release agent on a server, within the Environments tab of the Pipelines section of the Project."),U=f(),c=r("p"),re=o(`This works fine, the first time.
You can view the results of this in the DevOps portal `),H=r("code"),ae=o("https://dev.azure.com/<Team>/_settings/deploymentPools"),le=o(`.
The default names for Deployment Groups (used by releases) is `),X=r("code"),he=o("<Project>-<Environment>"),fe=o(`.
The default names for Environments (used by pipelines) is `),C=r("code"),pe=o("environment-<environment-id>-<guid>"),ce=o(`.
These names can be changed to aid ongoing maintenance.`),G=f(),D=r("p"),de=o("If you try to create a second agent on the same VM, in the same way, it will do one of 2 things:"),W=f(),m=r("ul"),z=r("li"),ue=o("Overwrite the first, meaning that any pipelines which reference this will cease to function"),me=f(),P=r("li"),ve=o(`Fail to create since it can’t delete the first agent.
In this case the second agent always shows as offline and the new pipeline won’t run.
`),N=r("code"),we=o("Unable to deploy to the virtual machine 'XXX' as the machine is offline"),Y=f(),v=r("p"),ye=o("Others have reported "),_=r("a"),be=o("this issue"),Ee=o(" and provided an alternative script. I am not comfortable just running scripts from the web, I prefer a future proof understanding of the problem."),$=f(),M=r("h2"),_e=o("The solution"),B=f(),d=r("p"),Te=o(`The reason for this issue is that the script generates an agent with a name matching the VM by default.
The DevOps-generated script is one-lined but otherwise not hard to dissect.
In the line which calls `),V=r("code"),Oe=o("config"),ge=o(" we need to change the "),x=r("code"),Ie=o("agent"),Ae=o(" parameter to something unique, either by appending the agent folder ("),q=r("code"),De=o("$destFolder"),Pe=o(" in the script), e.g. HOSTNAME-A3, or with something which indicates the purpose of this agent, e.g. HOSTNAME-ServiceX or HOSTNAME-WebsiteX, in which case we should probably update the script to create a folder name to match this."),J=f(),S=r("h2"),Me=o("The future"),K=f(),w=r("p"),Se=o("A "),T=r("a"),je=o("proposal"),He=o(" has been made to Microsoft to allow environment sharing but doesn’t seem active."),Q=f(),y=r("p"),Xe=o("Interestingly this was "),O=r("a"),Ce=o("resolved"),ze=o(" in the past for deployment groups, which are used by releases (as opposed to pipelines), so I’d assume that this will come eventually."),this.h()},l(e){u=a(e,"H1",{});var n=l(u);se=i(n,"Sharing environments between projects in Azure DevOps"),n.forEach(t),F=p(e),g=a(e,"P",{});var xe=l(g);oe=i(xe,"This is useful for multiple websites held in different projects hosted in the same IIS instance on the same server(s). Alternatively, for microservices hosted on a Virtual Machine, if deployed independently."),xe.forEach(t),k=p(e),I=a(e,"H2",{});var qe=l(I);ie=i(qe,"The issue"),qe.forEach(t),L=p(e),A=a(e,"P",{});var Fe=l(A);ne=i(Fe,"Azure DevOps generates the script for you to install a build/release agent on a server, within the Environments tab of the Pipelines section of the Project."),Fe.forEach(t),U=p(e),c=a(e,"P",{});var b=l(c);re=i(b,`This works fine, the first time.
You can view the results of this in the DevOps portal `),H=a(b,"CODE",{});var ke=l(H);ae=i(ke,"https://dev.azure.com/<Team>/_settings/deploymentPools"),ke.forEach(t),le=i(b,`.
The default names for Deployment Groups (used by releases) is `),X=a(b,"CODE",{});var Le=l(X);he=i(Le,"<Project>-<Environment>"),Le.forEach(t),fe=i(b,`.
The default names for Environments (used by pipelines) is `),C=a(b,"CODE",{});var Ue=l(C);pe=i(Ue,"environment-<environment-id>-<guid>"),Ue.forEach(t),ce=i(b,`.
These names can be changed to aid ongoing maintenance.`),b.forEach(t),G=p(e),D=a(e,"P",{});var Ge=l(D);de=i(Ge,"If you try to create a second agent on the same VM, in the same way, it will do one of 2 things:"),Ge.forEach(t),W=p(e),m=a(e,"UL",{});var R=l(m);z=a(R,"LI",{});var We=l(z);ue=i(We,"Overwrite the first, meaning that any pipelines which reference this will cease to function"),We.forEach(t),me=p(R),P=a(R,"LI",{});var Ne=l(P);ve=i(Ne,`Fail to create since it can’t delete the first agent.
In this case the second agent always shows as offline and the new pipeline won’t run.
`),N=a(Ne,"CODE",{});var Ye=l(N);we=i(Ye,"Unable to deploy to the virtual machine 'XXX' as the machine is offline"),Ye.forEach(t),Ne.forEach(t),R.forEach(t),Y=p(e),v=a(e,"P",{});var Z=l(v);ye=i(Z,"Others have reported "),_=a(Z,"A",{href:!0,rel:!0});var $e=l(_);be=i($e,"this issue"),$e.forEach(t),Ee=i(Z," and provided an alternative script. I am not comfortable just running scripts from the web, I prefer a future proof understanding of the problem."),Z.forEach(t),$=p(e),M=a(e,"H2",{});var Be=l(M);_e=i(Be,"The solution"),Be.forEach(t),B=p(e),d=a(e,"P",{});var E=l(d);Te=i(E,`The reason for this issue is that the script generates an agent with a name matching the VM by default.
The DevOps-generated script is one-lined but otherwise not hard to dissect.
In the line which calls `),V=a(E,"CODE",{});var Je=l(V);Oe=i(Je,"config"),Je.forEach(t),ge=i(E," we need to change the "),x=a(E,"CODE",{});var Ke=l(x);Ie=i(Ke,"agent"),Ke.forEach(t),Ae=i(E," parameter to something unique, either by appending the agent folder ("),q=a(E,"CODE",{});var Qe=l(q);De=i(Qe,"$destFolder"),Qe.forEach(t),Pe=i(E," in the script), e.g. HOSTNAME-A3, or with something which indicates the purpose of this agent, e.g. HOSTNAME-ServiceX or HOSTNAME-WebsiteX, in which case we should probably update the script to create a folder name to match this."),E.forEach(t),J=p(e),S=a(e,"H2",{});var Re=l(S);Me=i(Re,"The future"),Re.forEach(t),K=p(e),w=a(e,"P",{});var ee=l(w);Se=i(ee,"A "),T=a(ee,"A",{href:!0,rel:!0});var Ze=l(T);je=i(Ze,"proposal"),Ze.forEach(t),He=i(ee," has been made to Microsoft to allow environment sharing but doesn’t seem active."),ee.forEach(t),Q=p(e),y=a(e,"P",{});var te=l(y);Xe=i(te,"Interestingly this was "),O=a(te,"A",{href:!0,rel:!0});var et=l(O);Ce=i(et,"resolved"),et.forEach(t),ze=i(te," in the past for deployment groups, which are used by releases (as opposed to pipelines), so I’d assume that this will come eventually."),te.forEach(t),this.h()},h(){j(_,"href","https://github.com/MicrosoftDocs/azure-devops-docs/issues/8578"),j(_,"rel","nofollow"),j(T,"href","https://developercommunity.visualstudio.com/t/can-environments-be-shared-across-team-projects/676255"),j(T,"rel","nofollow"),j(O,"href","https://devblogs.microsoft.com/devops/sharing-of-deployment-groups-across-projects/"),j(O,"rel","nofollow")},m(e,n){h(e,u,n),s(u,se),h(e,F,n),h(e,g,n),s(g,oe),h(e,k,n),h(e,I,n),s(I,ie),h(e,L,n),h(e,A,n),s(A,ne),h(e,U,n),h(e,c,n),s(c,re),s(c,H),s(H,ae),s(c,le),s(c,X),s(X,he),s(c,fe),s(c,C),s(C,pe),s(c,ce),h(e,G,n),h(e,D,n),s(D,de),h(e,W,n),h(e,m,n),s(m,z),s(z,ue),s(m,me),s(m,P),s(P,ve),s(P,N),s(N,we),h(e,Y,n),h(e,v,n),s(v,ye),s(v,_),s(_,be),s(v,Ee),h(e,$,n),h(e,M,n),s(M,_e),h(e,B,n),h(e,d,n),s(d,Te),s(d,V),s(V,Oe),s(d,ge),s(d,x),s(x,Ie),s(d,Ae),s(d,q),s(q,De),s(d,Pe),h(e,J,n),h(e,S,n),s(S,Me),h(e,K,n),h(e,w,n),s(w,Se),s(w,T),s(T,je),s(w,He),h(e,Q,n),h(e,y,n),s(y,Xe),s(y,O),s(O,Ce),s(y,ze)},p:Ve,i:Ve,o:Ve,d(e){e&&t(u),e&&t(F),e&&t(g),e&&t(k),e&&t(I),e&&t(L),e&&t(A),e&&t(U),e&&t(c),e&&t(G),e&&t(D),e&&t(W),e&&t(m),e&&t(Y),e&&t(v),e&&t($),e&&t(M),e&&t(B),e&&t(d),e&&t(J),e&&t(S),e&&t(K),e&&t(w),e&&t(Q),e&&t(y)}}}class at extends st{constructor(u){super(),ot(this,u,null,nt,it,{})}}export{at as default};
